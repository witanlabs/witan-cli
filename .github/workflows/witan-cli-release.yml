name: Witan CLI Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version tag (example: v1.2.3)"
        required: true
        type: string

permissions:
  contents: write
  id-token: write

concurrency:
  group: witan-cli-release
  cancel-in-progress: false

jobs:
  release:
    name: Build and Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache-dependency-path: go.sum

      - name: Resolve version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          if ! [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+([-.+][0-9A-Za-z.-]+)?$ ]]; then
            echo "invalid version: $VERSION" >&2
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          if [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "stable=true" >> "$GITHUB_OUTPUT"
          else
            echo "stable=false" >> "$GITHUB_OUTPUT"
          fi
          echo "Resolved version: $VERSION"

      - name: Guard PyPI version collision (first attempt)
        if: steps.version.outputs.stable == 'true'
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          PYPI_VERSION="${VERSION#v}"
          VERSION_URL="https://pypi.org/pypi/witan/${PYPI_VERSION}/json"
          if curl -fsS "${VERSION_URL}" >/dev/null 2>&1; then
            if [[ "${GITHUB_RUN_ATTEMPT}" == "1" ]]; then
              echo "PyPI already has witan==${PYPI_VERSION}. Choose a new release version." >&2
              exit 1
            fi
            echo "witan==${PYPI_VERSION} already exists; continuing rerun attempt ${GITHUB_RUN_ATTEMPT}."
          else
            echo "witan==${PYPI_VERSION} is available on PyPI."
          fi

      - name: Build release artifacts
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          ./scripts/build-dist.sh "$VERSION" "${RUNNER_TEMP}/witan-dist"

      - name: Setup Python
        if: steps.version.outputs.stable == 'true'
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: pip

      - name: Install wheel build dependencies
        if: steps.version.outputs.stable == 'true'
        run: |
          python -m pip install --upgrade pip
          python -m pip install go-to-wheel==0.2

      - name: Build PyPI wheels
        if: steps.version.outputs.stable == 'true'
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          ./scripts/build-pypi-wheels.sh "$VERSION" "${RUNNER_TEMP}/witan-wheels"
          cp "${RUNNER_TEMP}"/witan-wheels/*.whl "${RUNNER_TEMP}/witan-dist/"

      - name: Regenerate checksums (include wheels)
        if: steps.version.outputs.stable == 'true'
        run: |
          cd "${RUNNER_TEMP}/witan-dist"
          shopt -s nullglob
          wheel_files=(*.whl)
          if [[ ${#wheel_files[@]} -eq 0 ]]; then
            echo "no wheel artifacts found in ${RUNNER_TEMP}/witan-dist" >&2
            exit 1
          fi
          artifacts=(
            witan-darwin-arm64.tar.gz
            witan-darwin-amd64.tar.gz
            witan-linux-amd64.tar.gz
            witan-linux-arm64.tar.gz
            witan-windows-amd64.zip
            witan-windows-arm64.zip
            "${wheel_files[@]}"
          )
          shasum -a 256 "${artifacts[@]}" > witan-checksums.txt

      - name: Smoke test wheel
        if: steps.version.outputs.stable == 'true'
        run: |
          WHEEL="$(ls -1 "${RUNNER_TEMP}/witan-wheels"/witan-*-manylinux_2_17_x86_64.whl | head -n 1)"
          python -m pip install "$WHEEL"
          witan --version

      - name: Show artifacts
        run: |
          ls -lah "${RUNNER_TEMP}/witan-dist"
          cat "${RUNNER_TEMP}/witan-dist/witan-checksums.txt"

      - name: Publish release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          NOTES="Automated release from witan-cli."
          ASSET_DIR="${RUNNER_TEMP}/witan-dist"
          ASSETS=(
            "${ASSET_DIR}/witan-darwin-arm64.tar.gz"
            "${ASSET_DIR}/witan-darwin-amd64.tar.gz"
            "${ASSET_DIR}/witan-linux-amd64.tar.gz"
            "${ASSET_DIR}/witan-linux-arm64.tar.gz"
            "${ASSET_DIR}/witan-windows-amd64.zip"
            "${ASSET_DIR}/witan-windows-arm64.zip"
            "${ASSET_DIR}/witan-checksums.txt"
          )
          while IFS= read -r -d '' wheel; do
            ASSETS+=("$wheel")
          done < <(find "${ASSET_DIR}" -maxdepth 1 -name "*.whl" -print0 | sort -z)

          CREATE_FLAGS=()
          EDIT_FLAGS=()
          if [[ "$VERSION" == *-* ]]; then
            CREATE_FLAGS+=(--prerelease)
            EDIT_FLAGS+=(--prerelease)
          else
            CREATE_FLAGS+=(--latest)
            EDIT_FLAGS+=(--latest)
          fi

          if gh release view "$VERSION" >/dev/null 2>&1; then
            gh release upload "$VERSION" "${ASSETS[@]}" --clobber
            gh release edit "$VERSION" \
              --title "Witan CLI ${VERSION}" \
              --notes "$NOTES" \
              "${EDIT_FLAGS[@]}"
          else
            gh release create "$VERSION" "${ASSETS[@]}" \
              --title "Witan CLI ${VERSION}" \
              --notes "$NOTES" \
              "${CREATE_FLAGS[@]}"
          fi

          echo "Published release: https://github.com/${GITHUB_REPOSITORY}/releases/tag/${VERSION}"

      - name: Publish wheels to PyPI
        if: steps.version.outputs.stable == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: ${{ runner.temp }}/witan-wheels
          skip-existing: true

      - name: Verify published PyPI package is CLI
        if: steps.version.outputs.stable == 'true'
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          PYPI_VERSION="${VERSION#v}"

          # Wait briefly for index consistency, then force reinstall from PyPI.
          for attempt in {1..10}; do
            python -m pip uninstall -y witan >/dev/null 2>&1 || true
            if python -m pip install --no-cache-dir --force-reinstall --index-url https://pypi.org/simple "witan==${PYPI_VERSION}"; then
              break
            fi
            if [[ "${attempt}" == "10" ]]; then
              echo "failed to install witan==${PYPI_VERSION} from PyPI after retries" >&2
              exit 1
            fi
            sleep 10
          done

          python - <<'PY'
          import importlib.metadata as md
          import os
          import sys

          expected = os.environ["VERSION"].lstrip("v")
          dist = md.distribution("witan")
          version = dist.version
          summary = dist.metadata.get("Summary") or ""
          home_page = dist.metadata.get("Home-page") or ""
          entry_points = [
              ep for ep in dist.entry_points if ep.group == "console_scripts" and ep.name == "witan"
          ]

          if version != expected:
              print(f"expected PyPI version {expected}, got {version}", file=sys.stderr)
              sys.exit(1)
          if not entry_points:
              print("installed PyPI package has no 'witan' console script", file=sys.stderr)
              sys.exit(1)
          if "cli" not in summary.lower() and "witan-cli" not in home_page:
              print(
                  f"unexpected package metadata for witan=={version}: summary={summary!r} home_page={home_page!r}",
                  file=sys.stderr,
              )
              sys.exit(1)

          print(f"verified PyPI package: witan=={version}")
          PY

          witan --version
