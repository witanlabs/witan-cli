name: Witan CLI Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version tag (example: v1.2.3)"
        required: true
        type: string

permissions:
  contents: write

concurrency:
  group: witan-cli-release
  cancel-in-progress: false

jobs:
  release:
    name: Build and Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache-dependency-path: go.sum

      - name: Resolve version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          if ! [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+([-.+][0-9A-Za-z.-]+)?$ ]]; then
            echo "invalid version: $VERSION" >&2
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Resolved version: $VERSION"

      - name: Build release artifacts
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          ./scripts/build-dist.sh "$VERSION" "${RUNNER_TEMP}/witan-dist"

      - name: Show artifacts
        run: |
          ls -lah "${RUNNER_TEMP}/witan-dist"
          cat "${RUNNER_TEMP}/witan-dist/witan-checksums.txt"

      - name: Publish release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          NOTES="Automated release from witan-cli."
          ASSET_DIR="${RUNNER_TEMP}/witan-dist"
          ASSETS=(
            "${ASSET_DIR}/witan-darwin-arm64.tar.gz"
            "${ASSET_DIR}/witan-darwin-amd64.tar.gz"
            "${ASSET_DIR}/witan-linux-amd64.tar.gz"
            "${ASSET_DIR}/witan-linux-arm64.tar.gz"
            "${ASSET_DIR}/witan-windows-amd64.zip"
            "${ASSET_DIR}/witan-windows-arm64.zip"
            "${ASSET_DIR}/witan-checksums.txt"
          )

          CREATE_FLAGS=()
          EDIT_FLAGS=()
          if [[ "$VERSION" == *-* ]]; then
            CREATE_FLAGS+=(--prerelease)
            EDIT_FLAGS+=(--prerelease)
          else
            CREATE_FLAGS+=(--latest)
            EDIT_FLAGS+=(--latest)
          fi

          if gh release view "$VERSION" >/dev/null 2>&1; then
            gh release upload "$VERSION" "${ASSETS[@]}" --clobber
            gh release edit "$VERSION" \
              --title "Witan CLI ${VERSION}" \
              --notes "$NOTES" \
              "${EDIT_FLAGS[@]}"
          else
            gh release create "$VERSION" "${ASSETS[@]}" \
              --title "Witan CLI ${VERSION}" \
              --notes "$NOTES" \
              "${CREATE_FLAGS[@]}"
          fi

          echo "Published release: https://github.com/${GITHUB_REPOSITORY}/releases/tag/${VERSION}"
