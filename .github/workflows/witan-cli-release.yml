name: Witan CLI Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version tag (example: v1.2.3)"
        required: true
        type: string

permissions:
  contents: write
  id-token: write

concurrency:
  group: witan-cli-release
  cancel-in-progress: false

jobs:
  release:
    name: Build and Publish
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache-dependency-path: go.sum

      - name: Resolve version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi

          if ! [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+([-.+][0-9A-Za-z.-]+)?$ ]]; then
            echo "invalid version: $VERSION" >&2
            exit 1
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          if [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "stable=true" >> "$GITHUB_OUTPUT"
          else
            echo "stable=false" >> "$GITHUB_OUTPUT"
          fi
          echo "Resolved version: $VERSION"

      - name: Build release artifacts
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          ./scripts/build-dist.sh "$VERSION" "${RUNNER_TEMP}/witan-dist"

      - name: Setup Python
        if: steps.version.outputs.stable == 'true'
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"
          cache: pip

      - name: Install wheel build dependencies
        if: steps.version.outputs.stable == 'true'
        run: |
          python -m pip install --upgrade pip
          python -m pip install go-to-wheel==0.2

      - name: Build PyPI wheels
        if: steps.version.outputs.stable == 'true'
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          ./scripts/build-pypi-wheels.sh "$VERSION" "${RUNNER_TEMP}/witan-wheels"
          cp "${RUNNER_TEMP}"/witan-wheels/*.whl "${RUNNER_TEMP}/witan-dist/"

      - name: Regenerate checksums (include wheels)
        if: steps.version.outputs.stable == 'true'
        run: |
          cd "${RUNNER_TEMP}/witan-dist"
          shopt -s nullglob
          wheel_files=(*.whl)
          if [[ ${#wheel_files[@]} -eq 0 ]]; then
            echo "no wheel artifacts found in ${RUNNER_TEMP}/witan-dist" >&2
            exit 1
          fi
          artifacts=(
            witan-darwin-arm64.tar.gz
            witan-darwin-amd64.tar.gz
            witan-linux-amd64.tar.gz
            witan-linux-arm64.tar.gz
            witan-windows-amd64.zip
            witan-windows-arm64.zip
            "${wheel_files[@]}"
          )
          shasum -a 256 "${artifacts[@]}" > witan-checksums.txt

      - name: Smoke test wheel
        if: steps.version.outputs.stable == 'true'
        run: |
          WHEEL="$(ls -1 "${RUNNER_TEMP}/witan-wheels"/witan-*-manylinux_2_17_x86_64.whl | head -n 1)"
          python -m pip install "$WHEEL"
          witan --version

      - name: Show artifacts
        run: |
          ls -lah "${RUNNER_TEMP}/witan-dist"
          cat "${RUNNER_TEMP}/witan-dist/witan-checksums.txt"

      - name: Publish release
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          NOTES="Automated release from witan-cli."
          ASSET_DIR="${RUNNER_TEMP}/witan-dist"
          ASSETS=(
            "${ASSET_DIR}/witan-darwin-arm64.tar.gz"
            "${ASSET_DIR}/witan-darwin-amd64.tar.gz"
            "${ASSET_DIR}/witan-linux-amd64.tar.gz"
            "${ASSET_DIR}/witan-linux-arm64.tar.gz"
            "${ASSET_DIR}/witan-windows-amd64.zip"
            "${ASSET_DIR}/witan-windows-arm64.zip"
            "${ASSET_DIR}/witan-checksums.txt"
          )
          while IFS= read -r -d '' wheel; do
            ASSETS+=("$wheel")
          done < <(find "${ASSET_DIR}" -maxdepth 1 -name "*.whl" -print0 | sort -z)

          CREATE_FLAGS=()
          EDIT_FLAGS=()
          if [[ "$VERSION" == *-* ]]; then
            CREATE_FLAGS+=(--prerelease)
            EDIT_FLAGS+=(--prerelease)
          else
            CREATE_FLAGS+=(--latest)
            EDIT_FLAGS+=(--latest)
          fi

          if gh release view "$VERSION" >/dev/null 2>&1; then
            gh release upload "$VERSION" "${ASSETS[@]}" --clobber
            gh release edit "$VERSION" \
              --title "Witan CLI ${VERSION}" \
              --notes "$NOTES" \
              "${EDIT_FLAGS[@]}"
          else
            gh release create "$VERSION" "${ASSETS[@]}" \
              --title "Witan CLI ${VERSION}" \
              --notes "$NOTES" \
              "${CREATE_FLAGS[@]}"
          fi

          echo "Published release: https://github.com/${GITHUB_REPOSITORY}/releases/tag/${VERSION}"

      - name: Publish wheels to PyPI
        if: steps.version.outputs.stable == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: ${{ runner.temp }}/witan-wheels
          skip-existing: true
